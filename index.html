<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise OTIF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos adicionais para uma melhor aparência */
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 1280px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message" class="text-gray-700 font-semibold">A processar...</span>
        </div>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto flex items-center justify-between p-4">
            <h1 class="text-2xl font-bold text-gray-800">Análise OTIF</h1>
            <nav>
                <button id="nav-dashboard" class="py-2 px-4 font-semibold rounded-md transition-colors bg-blue-500 text-white">
                    Dashboard
                </button>
                <button id="nav-import" class="ml-4 py-2 px-4 font-semibold rounded-md transition-colors text-gray-600 hover:bg-gray-200">
                    Importar Arquivo
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Vista de Importação -->
        <div id="import-view" style="display: none;">
            <div class="flex flex-col items-center justify-center p-4 gap-8">
                <div id="drop-zone" class="w-full max-w-2xl p-8 text-center bg-white rounded-lg shadow-lg border-2 border-dashed border-gray-300">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    <h2 class="mt-4 text-2xl font-bold text-gray-800">Importar Novo Ficheiro</h2>
                    <p class="mt-2 text-sm text-gray-500">Arraste e solte um ficheiro .csv ou .xlsx aqui.</p>
                    <div class="mt-6">
                        <input type="file" id="file-upload" class="hidden" accept=".csv, .xlsx">
                        <label for="file-upload" class="cursor-pointer bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">
                            Ou Selecione um Ficheiro
                        </label>
                    </div>
                     <p id="import-error" class="mt-4 text-sm text-red-600"></p>
                </div>
                <div class="w-full max-w-2xl p-8 bg-white rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ficheiros Carregados</h3>
                    <ul id="loaded-files-list" class="space-y-3">
                       <!-- A lista de ficheiros será inserida aqui -->
                    </ul>
                     <div class="mt-6 border-t pt-6">
                        <button id="clear-history-btn" class="w-full font-bold py-2 px-4 rounded-md transition-colors bg-red-500 text-white hover:bg-red-600">
                            Limpar Todo o Histórico
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista do Dashboard -->
        <div id="dashboard-view">
             <!-- O conteúdo do dashboard será inserido aqui -->
        </div>
    </main>

    <script type="module">
        // --- CONFIGURAÇÃO ---
        const DB_NAME = 'otif-dashboard-db';
        const DB_VERSION = 1;
        const FILE_STORE = 'files';
        const DATA_STORE = 'data';

        // --- ESTADO DA APLICAÇÃO ---
        let allData = [];
        let loadedFiles = [];
        let currentView = 'dashboard';
        let appliedDateRange = { start: '', end: '' };
        let selectedRegion = null;
        let selectedCarrier = null;
        let selectedReason = null; // { reason: '...', type: 'delay' | 'discrepancy' }

        // --- ELEMENTOS DO DOM ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const navDashboard = document.getElementById('nav-dashboard');
        const navImport = document.getElementById('nav-import');
        const importView = document.getElementById('import-view');
        const dashboardView = document.getElementById('dashboard-view');
        const dropZone = document.getElementById('drop-zone');
        const fileUpload = document.getElementById('file-upload');
        const importError = document.getElementById('import-error');
        const loadedFilesList = document.getElementById('loaded-files-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // --- BASE DE DADOS INDEXEDDB ---
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject("Erro ao abrir a base de dados.");
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = event => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(FILE_STORE)) {
                    db.createObjectStore(FILE_STORE, { keyPath: 'name' });
                }
                if (!db.objectStoreNames.contains(DATA_STORE)) {
                    const dataStore = db.createObjectStore(DATA_STORE, { autoIncrement: true });
                    dataStore.createIndex('fileName', 'fileName', { unique: false });
                }
            };
        });
        
        // --- FUNÇÕES DE CONTROLO ---
        const showLoading = (message = 'A processar...') => {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        };

        const hideLoading = () => {
            loadingOverlay.style.display = 'none';
        };
        
        const switchView = (view) => {
            currentView = view;
            if (view === 'dashboard') {
                dashboardView.style.display = 'block';
                importView.style.display = 'none';
                navDashboard.classList.add('bg-blue-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-200');
                navImport.classList.remove('bg-blue-500', 'text-white');
                navImport.classList.add('text-gray-600', 'hover:bg-gray-200');
            } else {
                dashboardView.style.display = 'none';
                importView.style.display = 'block';
                navImport.classList.add('bg-blue-500', 'text-white');
                navImport.classList.remove('text-gray-600', 'hover:bg-gray-200');
                navDashboard.classList.remove('bg-blue-500', 'text-white');
                navDashboard.classList.add('text-gray-600', 'hover:bg-gray-200');
            }
        };

        const goBackToDashboard = () => {
            selectedRegion = null;
            selectedReason = null;
            selectedCarrier = null;
            renderDashboard();
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        const getOtifColorClass = (value) => {
            if (value >= 96) return 'bg-green-500';
            if (value > 90) return 'bg-yellow-400';
            return 'bg-red-500';
        };

        const getOtifTextColorClass = (value) => {
            if (value > 90 && value < 96) return 'text-black';
            return 'text-white';
        };

        const renderLoadedFiles = () => {
            if (loadedFiles.length === 0) {
                loadedFilesList.innerHTML = `<p class="text-gray-500">Nenhum ficheiro foi carregado ainda.</p>`;
                return;
            }
            loadedFilesList.innerHTML = loadedFiles.map(file => `
                <li class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="text-gray-700 truncate pr-4">${file.name}</span>
                    <button data-filename="${file.name}" class="remove-file-btn text-red-500 hover:text-red-700 font-semibold flex-shrink-0">Remover</button>
                </li>
            `).join('');
        };
        
        const renderDashboard = () => {
             if (allData.length === 0) {
                dashboardView.innerHTML = `
                    <div class="text-center bg-white p-8 rounded-lg shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h2 class="mt-4 text-2xl font-bold text-gray-800 mb-4">Bem-vindo ao Dashboard OTIF</h2>
                        <p class="text-gray-600 mb-6">Nenhum dado foi carregado. Por favor, vá à aba "Importar Arquivo" para começar.</p>
                        <button id="go-to-import-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-600 transition-colors">
                            Importar Arquivo
                        </button>
                    </div>
                `;
                return;
            }
            
            const metrics = calculateMetrics();

            if (selectedCarrier) {
                dashboardView.innerHTML = renderCarrierDetailView(selectedCarrier, metrics);
                return;
            }

            if (selectedReason) {
                dashboardView.innerHTML = renderReasonDetailView(selectedReason, metrics.carrierPerformanceByReason);
                return;
            }

            if(selectedRegion && metrics.carrierPerformanceByRegion[selectedRegion]) {
                dashboardView.innerHTML = renderRegionDetailView(selectedRegion, metrics.carrierPerformanceByRegion[selectedRegion]);
                return;
            }

            if (!metrics || metrics.totalDeliveries === 0) {
                 dashboardView.innerHTML = `
                     <header class="mb-8">
                        ${renderDashboardHeader(metrics)}
                        ${renderDateFilter()}
                    </header>
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                         <h3 class="text-lg font-semibold mb-4 text-gray-700">Nenhum dado encontrado</h3>
                         <p class="text-gray-500">Não há registos que correspondam ao período selecionado.</p>
                    </div>`;
                return;
            }
            
            dashboardView.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    ${renderSingleMetricChart(metrics.monthlyPerformance, 'Performance Mensal - OTIF', 'otifRate', metrics.yearForHistory)}
                    ${renderSingleMetricChart(metrics.monthlyPerformance, 'Performance Mensal - On Time', 'onTimeRate', metrics.yearForHistory)}
                    ${renderSingleMetricChart(metrics.monthlyPerformance, 'Performance Mensal - In Full', 'inFullRate', metrics.yearForHistory)}
                </div>
                <header class="mb-8">
                    ${renderDashboardHeader(metrics)}
                    ${renderDateFilter()}
                </header>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderStatCard('OTIF Geral', `${metrics.otifRate.toFixed(2)}%`, 'bg-blue-100 text-blue-600', '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>')}
                    ${renderStatCard('On-Time (No Prazo)', `${metrics.onTimeRate.toFixed(2)}%`, 'bg-green-100 text-green-600', '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>')}
                    ${renderStatCard('In-Full (Sem Divergência)', `${metrics.inFullRate.toFixed(2)}%`, 'bg-indigo-100 text-indigo-600', '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>')}
                    ${renderStatCard('Total de Linhas', metrics.totalDeliveries.toLocaleString('pt-BR'), 'bg-gray-200 text-gray-700', '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0h-2" /></svg>')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    ${renderBarChart('carrier-performance', metrics.carrierPerformance, 'Performance OTIF por Transportadora (Clique para detalhar)', true)}
                    ${renderBarChart('region-performance', metrics.regionPerformance, 'Performance OTIF por Região (Clique para detalhar)', true)}
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${renderReasonTable(metrics.topDelayReasons, 'Principais Motivos de Atraso', metrics.totalDeliveries - metrics.totalCategorizedDelays, 'delay')}
                    ${renderReasonTable(metrics.topDiscrepancyReasons, 'Principais Motivos de Divergência', metrics.totalDeliveries - metrics.totalCategorizedDiscrepancies, 'discrepancy')}
                </div>
            `;
        };

        const renderDashboardHeader = (metrics) => `
            <div class="flex flex-wrap justify-between items-start gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Resumo da Performance</h2>
                    <p class="text-gray-600">Analisando ${loadedFiles.length} ficheiro(s) com ${allData.length.toLocaleString('pt-BR')} linhas.</p>
                </div>
            </div>`;
            
        const renderDateFilter = () => `
             <div class="bg-white p-4 rounded-lg shadow-md flex flex-wrap items-center gap-4">
                <span class="font-semibold text-gray-700">Filtrar por Período:</span>
                <div>
                    <label for="start-date" class="text-sm text-gray-600 mr-2">De:</label>
                    <input type="date" name="start" id="start-date" value="${appliedDateRange.start}" class="border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                   <label for="end-date" class="text-sm text-gray-600 mr-2">Até:</label>
                   <input type="date" name="end" id="end-date" value="${appliedDateRange.end}" class="border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <button id="apply-filter-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Aplicar</button>
                <button id="clear-filter-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">Limpar Filtro</button>
            </div>`;

        const renderStatCard = (title, value, color, icon) => `
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                <div class="mr-4 p-3 rounded-full ${color}">${icon}</div>
                <div>
                    <p class="text-sm text-gray-500">${title}</p>
                    <p class="text-2xl font-bold">${value}</p>
                </div>
            </div>`;

        const renderBarChart = (id, chartData, title, isClickable = false) => {
             if (!chartData || chartData.length === 0) {
                return `<div id="${id}" class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold mb-4 text-gray-700">${title}</h3><p class="text-gray-500">Não há dados suficientes para exibir.</p></div>`;
            }
            const maxValue = Math.max(...chartData.map(item => item.value));
            return `
                <div id="${id}" class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${title}</h3>
                    <div class="space-y-4">
                        ${chartData.map(item => `
                            <div data-label="${item.label}" class="flex items-center group ${isClickable ? 'cursor-pointer clickable-bar' : ''}">
                                <p class="w-2/5 text-sm text-gray-600 truncate pr-2 group-hover:text-blue-600">${item.label} <span class="text-xs text-gray-400">(${item.totalCount})</span></p>
                                <div class="w-3/5 bg-gray-200 rounded-full h-6">
                                    <div class="${getOtifColorClass(item.value)} h-6 rounded-full ${getOtifTextColorClass(item.value)} text-xs flex items-center justify-end pr-2 group-hover:opacity-80 transition-opacity" style="width: ${(maxValue > 0 ? (item.value / maxValue) * 100 : 0)}%;">
                                        ${item.value.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        };

        const renderReasonTable = (tableData, title, total, type) => {
            if (!tableData || tableData.length === 0) {
                 return `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold mb-4 text-gray-700">${title}</h3><p class="text-gray-500">Nenhum motivo registrado.</p></div>`;
            }
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${title} (Clique para detalhar)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ocorrências</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentual</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableData.map(item => `
                                    <tr data-reason="${item.reason}" data-type="${type}" class="reason-row cursor-pointer hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.reason}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.count}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${total > 0 ? ((item.count / total) * 100).toFixed(2) : '0.00'}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        };
        
        const renderRegionDetailView = (region, regionData) => {
             if (!regionData || regionData.length === 0) {
                return `
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                    <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Performance por Transportadora na Região: <span class="text-blue-600">${region}</span></h3>
                    <p class="text-gray-500">Nenhum dado de transportadora encontrado para esta região.</p>
                </div>`;
            }

            return `
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                     <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Performance por Transportadora na Região: <span class="text-blue-600">${region}</span></h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transportadora</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Entregas (Atraso/Total)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">OTIF %</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">On-Time %</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">In-Full %</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${regionData.map(item => `
                                     <tr>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${item.label}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${item.delayCount} de ${item.totalCount}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500"><div class="w-full bg-gray-200 rounded-full h-5 relative"><div class="${getOtifColorClass(item.otifPercentage)} h-5 rounded-full" style="width: ${item.otifPercentage.toFixed(2)}%;"></div><span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${getOtifTextColorClass(item.otifPercentage)} px-2">${item.otifPercentage.toFixed(2)}%</span></div></td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500"><div class="w-full bg-gray-200 rounded-full h-5 relative"><div class="${getOtifColorClass(item.onTimePercentage)} h-5 rounded-full" style="width: ${item.onTimePercentage.toFixed(2)}%;"></div><span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${getOtifTextColorClass(item.onTimePercentage)} px-2">${item.onTimePercentage.toFixed(2)}%</span></div></td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500"><div class="w-full bg-gray-200 rounded-full h-5 relative"><div class="${getOtifColorClass(item.inFullPercentage)} h-5 rounded-full" style="width: ${item.inFullPercentage.toFixed(2)}%;"></div><span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${getOtifTextColorClass(item.inFullPercentage)} px-2">${item.inFullPercentage.toFixed(2)}%</span></div></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        };

        const renderReasonDetailView = (reasonInfo, detailData) => {
            const typeText = reasonInfo.type === 'delay' ? 'Atraso' : 'Divergência';
            const dataForReason = detailData[reasonInfo.type][reasonInfo.reason];

            if (!dataForReason) {
                return `
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                    <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Detalhes para o Motivo de ${typeText}: <span class="text-blue-600">${reasonInfo.reason}</span></h3>
                    <p class="text-gray-500">Nenhum dado de transportadora encontrado para este motivo.</p>
                </div>`;
            }

            const totalOccurrences = Object.values(dataForReason).reduce((a, b) => a + b, 0);
            const tableData = Object.entries(dataForReason)
                .map(([carrier, count]) => ({ label: carrier, count }))
                .sort((a, b) => b.count - a.count);

            return `
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                    <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Detalhes para o Motivo de ${typeText}: <span class="text-blue-600">${reasonInfo.reason}</span></h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transportadora</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ocorrências</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentual do Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableData.map(item => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.label}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.count}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${((item.count / totalOccurrences) * 100).toFixed(2)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        };

        const renderCarrierDetailView = (carrierName, metrics) => {
            const historicalData = metrics.historicalCarrierOtif;
            const year = metrics.yearForHistory;
            
            if (!historicalData || !historicalData[carrierName]) {
                 return `
                    <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                        <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Histórico Mensal para: <span class="text-blue-600">${carrierName}</span></h3>
                        <p class="text-gray-500">Nenhum dado histórico encontrado para esta transportadora.</p>
                    </div>`;
            }

            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const chartData = months.map((monthName, index) => {
                const monthKey = `${year}-${String(index + 1).padStart(2, '0')}`;
                const monthData = historicalData[carrierName][monthKey];
                return {
                    label: monthName,
                    value: monthData ? monthData.value : undefined,
                    totalCount: monthData ? monthData.totalCount : 0,
                };
            });
            
            let html = `
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
                    <button id="back-to-dashboard" class="mb-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">&larr; Voltar</button>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Histórico Mensal de OTIF para <span class="text-blue-600">${carrierName}</span> (${year})</h3>
                    <div class="relative flex" style="height: 300px;">
                        <div class="flex flex-col justify-between text-xs text-gray-500 pr-2 border-r border-gray-200 h-full pb-5">
                            <span>100%</span>
                            <span>75%</span>
                            <span>50%</span>
                            <span>25%</span>
                            <span>0%</span>
                        </div>
                        <div class="flex-1 grid grid-cols-12 pl-2 border-b border-gray-200">`;

            chartData.forEach(item => {
                html += `
                    <div class="relative flex justify-center items-end h-full px-1">`;

                if (item.value !== undefined) {
                     html += `
                        <div class="absolute text-center w-full text-xs font-bold text-gray-800" style="bottom: calc(${item.value}% + 4px);">
                           ${item.value.toFixed(1)}%
                        </div>
                        <div class="${getOtifColorClass(item.value)} w-3/4" style="height: ${item.value}%;"></div>`;
                }
                
                html += `</div>`;
            });
            
            html += `</div></div>`; // Fim da área do gráfico
             // Eixo X
            html += `<div class="flex pl-10 pt-2">
                        <div class="grid grid-cols-12 w-full">
                            ${chartData.map(item => `
                                <div class="text-center text-xs text-gray-500">
                                    <div>${item.label}</div>
                                    <div class="text-gray-400">(${item.totalCount})</div>
                                </div>
                            `).join('')}
                        </div>
                     </div>`;

            html += `</div>`; // Fim do container
            return html;
        };

        const renderSingleMetricChart = (monthlyData, title, metricKey, year) => {
            if (!monthlyData || monthlyData.length === 0) {
                return '';
            }

            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            let html = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${title} (${year})</h3>
                    <div class="relative flex" style="height: 250px;">
                        <div class="flex flex-col justify-between text-xs text-gray-500 pr-2 border-r border-gray-200 h-full pb-5">
                            <span>100%</span>
                            <span>75%</span>
                            <span>50%</span>
                            <span>25%</span>
                            <span>0%</span>
                        </div>
                        <div class="flex-1 grid grid-cols-12 pl-2 border-b border-gray-200">`;

            monthlyData.forEach(monthData => {
                const value = monthData[metricKey];
                html += `<div class="relative flex justify-center items-end h-full px-1 group">`;
                if (value !== undefined) {
                     html += `
                        <div class="absolute text-center w-full text-xs font-bold text-gray-800" style="bottom: calc(${value}% + 4px);">
                           ${value.toFixed(1)}%
                        </div>
                        <div class="${getOtifColorClass(value)} w-3/4" style="height: ${value}%;"></div>`;
                }
                html += `</div>`;
            });
            
            html += `</div></div>`; // Fim da área do gráfico
            
            // Eixo X
            html += `<div class="flex pl-10 pt-2">
                        <div class="grid grid-cols-12 w-full">
                            ${months.map(m => `<div class="text-center text-xs text-gray-500">${m}</div>`).join('')}
                        </div>
                     </div>`;

            html += `</div>`; // Fim do container
            return html;
        };


        // --- LÓGICA DE DADOS ---
        const parseDate = (rowDateStr) => {
            if (typeof rowDateStr === 'number') { // Formato Excel
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + rowDateStr * 86400000);
            }
            if (String(rowDateStr).includes('/')) { // Formato DD/MM/YYYY
                const parts = rowDateStr.split('/');
                return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
            }
            // Formato YYYY-MM-DD
            return new Date(rowDateStr + 'T00:00:00');
        };

        const calculateMetrics = () => {
             const filteredData = allData.filter(row => {
                const rowDateStr = row['Data Pedido'];
                if (!rowDateStr) return false; 
                
                const rowDate = parseDate(rowDateStr);
                if(isNaN(rowDate.getTime())) return false; 

                const startDate = appliedDateRange.start ? new Date(appliedDateRange.start + 'T00:00:00') : null;
                const endDate = appliedDateRange.end ? new Date(appliedDateRange.end + 'T23:59:59') : null;

                if (startDate && rowDate < startDate) return false;
                if (endDate && rowDate > endDate) return false;
                
                return true;
            });

            const processedData = filteredData.map(row => {
                const isOnTime = row['Status Entrega'] !== 'Fora do Prazo';
                const isInFull = !row['Entrega divergente?'] || String(row['Entrega divergente?']).toLowerCase() !== 'sim';
                return { ...row, isOnTime, isInFull };
            });

            const totalDeliveries = filteredData.length;
            const otifCount = processedData.filter(d => d.isOnTime && d.isInFull).length;
            const onTimeCount = processedData.filter(d => d.isOnTime).length;
            const inFullCount = processedData.filter(d => d.isInFull).length;
            
            const otifRate = totalDeliveries > 0 ? (otifCount / totalDeliveries) * 100 : 0;
            const onTimeRate = totalDeliveries > 0 ? (onTimeCount / totalDeliveries) * 100 : 0;
            const inFullRate = totalDeliveries > 0 ? (inFullCount / totalDeliveries) * 100 : 0;

            const byCarrier = processedData.reduce((acc, curr) => {
                const carrier = curr['TRANSPORTADORA'];
                if (!carrier) return acc;
                if (!acc[carrier]) acc[carrier] = { total: 0, otif: 0 };
                acc[carrier].total++;
                if (curr.isOnTime && curr.isInFull) acc[carrier].otif++;
                return acc;
            }, {});
            const carrierPerformance = Object.entries(byCarrier).map(([label, values]) => ({
                label, 
                value: (values.otif / values.total) * 100,
                totalCount: values.total
            })).sort((a, b) => b.value - a.value);

            const byRegion = processedData.reduce((acc, curr) => {
                const region = curr['Região'];
                if (!region) return acc;
                if (!acc[region]) acc[region] = { total: 0, otif: 0 };
                acc[region].total++;
                if (curr.isOnTime && curr.isInFull) acc[region].otif++;
                return acc;
            }, {});
            const regionPerformance = Object.entries(byRegion).map(([label, values]) => ({
                label,
                value: (values.otif / values.total) * 100,
                totalCount: values.total
            })).sort((a, b) => b.value - a.value);

            const delayReasons = processedData.filter(row => !row.isOnTime && row['Motivos']).reduce((acc, curr) => {
                const reason = curr['Motivos'];
                acc[reason] = (acc[reason] || 0) + 1;
                return acc;
            }, {});
            const topDelayReasons = Object.entries(delayReasons).map(([reason, count]) => ({ reason, count })).sort((a, b) => b.count - a.count);
            
            const discrepancyReasons = processedData.filter(row => !row.isInFull && row['Divergência']).reduce((acc, curr) => {
                const reason = curr['Divergência'];
                acc[reason] = (acc[reason] || 0) + 1;
                return acc;
            }, {});
            const topDiscrepancyReasons = Object.entries(discrepancyReasons).map(([reason, count]) => ({ reason, count })).sort((a, b) => b.count - a.count);
            
            const carrierPerformanceByRegion = processedData.reduce((acc, curr) => {
                const region = curr['Região'];
                const carrier = curr['TRANSPORTADORA'];
                if (!region || !carrier) return acc;
                if (!acc[region]) acc[region] = {};
                if (!acc[region][carrier]) acc[region][carrier] = { totalCount: 0, onTimeCount: 0, inFullCount: 0, otifCount: 0 };
                acc[region][carrier].totalCount++;
                if (curr.isOnTime) acc[region][carrier].onTimeCount++;
                if (curr.isInFull) acc[region][carrier].inFullCount++;
                if (curr.isOnTime && curr.isInFull) acc[region][carrier].otifCount++;
                return acc;
            }, {});
            
            const carrierPerformanceByReason = { delay: {}, discrepancy: {} };
            processedData.forEach(row => {
                const carrier = row['TRANSPORTADORA'];
                if (!carrier) return;
                if (!row.isOnTime && row['Motivos']) {
                    const reason = row['Motivos'];
                    if (!carrierPerformanceByReason.delay[reason]) carrierPerformanceByReason.delay[reason] = {};
                    carrierPerformanceByReason.delay[reason][carrier] = (carrierPerformanceByReason.delay[reason][carrier] || 0) + 1;
                }
                if (!row.isInFull && row['Divergência']) {
                    const reason = row['Divergência'];
                    if (!carrierPerformanceByReason.discrepancy[reason]) carrierPerformanceByReason.discrepancy[reason] = {};
                    carrierPerformanceByReason.discrepancy[reason][carrier] = (carrierPerformanceByReason.discrepancy[reason][carrier] || 0) + 1;
                }
            });

            Object.keys(carrierPerformanceByRegion).forEach(region => {
                carrierPerformanceByRegion[region] = Object.entries(carrierPerformanceByRegion[region])
                    .map(([carrierLabel, counts]) => ({
                        label: carrierLabel,
                        totalCount: counts.totalCount,
                        delayCount: counts.totalCount - counts.onTimeCount,
                        otifPercentage: counts.totalCount > 0 ? (counts.otifCount / counts.totalCount) * 100 : 0,
                        onTimePercentage: counts.totalCount > 0 ? (counts.onTimeCount / counts.totalCount) * 100 : 0,
                        inFullPercentage: counts.totalCount > 0 ? (counts.inFullCount / counts.totalCount) * 100 : 0
                    }))
                    .sort((a, b) => a.otifPercentage - b.otifPercentage);
            });

            // --- LÓGICA DO HISTÓRICO ---
            const latestYear = allData.length > 0 ? Math.max(...allData.map(r => parseDate(r['Data Pedido']).getFullYear()).filter(y => !isNaN(y))) : new Date().getFullYear();
            const yearData = allData.filter(row => {
                const rowDate = parseDate(row['Data Pedido']);
                return rowDate && !isNaN(rowDate.getTime()) && rowDate.getFullYear() === latestYear;
            });

            const monthlyPerformanceData = yearData.reduce((acc, curr) => {
                const rowDate = parseDate(curr['Data Pedido']);
                if (isNaN(rowDate.getTime())) return acc;

                const monthKey = `${rowDate.getFullYear()}-${String(rowDate.getMonth() + 1).padStart(2, '0')}`;
                const isOnTime = curr['Status Entrega'] !== 'Fora do Prazo';
                const isInFull = !curr['Entrega divergente?'] || String(curr['Entrega divergente?']).toLowerCase() !== 'sim';
                
                if (!acc[monthKey]) acc[monthKey] = { total: 0, otifCount: 0, onTimeCount: 0, inFullCount: 0 };
                
                acc[monthKey].total++;
                if(isOnTime) acc[monthKey].onTimeCount++;
                if(isInFull) acc[monthKey].inFullCount++;
                if (isOnTime && isInFull) acc[monthKey].otifCount++;
                
                return acc;
            }, {});

            const monthlyPerformance = Array.from({ length: 12 }).map((_, index) => {
                const monthKey = `${latestYear}-${String(index + 1).padStart(2, '0')}`;
                const data = monthlyPerformanceData[monthKey];
                if (data && data.total > 0) {
                    return {
                        month: monthKey,
                        otifRate: (data.otifCount / data.total) * 100,
                        onTimeRate: (data.onTimeCount / data.total) * 100,
                        inFullRate: (data.inFullCount / data.total) * 100,
                    };
                }
                return {
                    month: monthKey,
                    otifRate: 0,
                    onTimeRate: 0,
                    inFullRate: 0,
                };
            });

            const historicalCarrierOtif = yearData.reduce((acc, curr) => {
                const carrier = curr['TRANSPORTADORA'];
                const rowDate = parseDate(curr['Data Pedido']);
                if (!carrier || isNaN(rowDate.getTime())) return acc;

                const month = `${rowDate.getFullYear()}-${String(rowDate.getMonth() + 1).padStart(2, '0')}`;
                const isOnTime = curr['Status Entrega'] !== 'Fora do Prazo';
                const isInFull = !curr['Entrega divergente?'] || String(curr['Entrega divergente?']).toLowerCase() !== 'sim';

                if (!acc[carrier]) acc[carrier] = {};
                if (!acc[carrier][month]) acc[carrier][month] = { total: 0, otifCount: 0 };

                acc[carrier][month].total++;
                if (isOnTime && isInFull) acc[carrier][month].otifCount++;
                
                return acc;
            }, {});
            Object.keys(historicalCarrierOtif).forEach(carrier => {
                Object.keys(historicalCarrierOtif[carrier]).forEach(month => {
                    const { total, otifCount } = historicalCarrierOtif[carrier][month];
                    historicalCarrierOtif[carrier][month] = {
                        value: (otifCount / total) * 100,
                        totalCount: total,
                    };
                });
            });


            return { 
                totalDeliveries, otifRate, onTimeRate, inFullRate, carrierPerformance, regionPerformance, 
                topDelayReasons, totalCategorizedDelays: onTimeCount,
                topDiscrepancyReasons, totalCategorizedDiscrepancies: inFullCount, 
                carrierPerformanceByRegion,
                carrierPerformanceByReason,
                historicalCarrierOtif,
                monthlyPerformance,
                yearForHistory: latestYear
            };
        };

        const processFile = async (file) => {
             if (!file) return;
        
            importError.textContent = '';
            if (loadedFiles.some(f => f.name === file.name)) {
                importError.textContent = `O ficheiro "${file.name}" já foi importado.`;
                return;
            }

            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            reader.onload = async (e) => {
                try {
                    let rawData = [];
                     if (fileExtension === 'csv') {
                        const text = e.target.result;
                        const lines = text.trim().split(/\r?\n/);
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        rawData = lines.slice(1).map(line => {
                            const values = line.split(',');
                            return headers.reduce((obj, header, index) => {
                                obj[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                                return obj;
                            }, {});
                        });
                    } else if (fileExtension === 'xlsx') {
                        if (typeof XLSX === 'undefined') {
                           importError.textContent = 'A biblioteca de leitura de planilhas (XLSX) não pôde ser carregada.';
                           return;
                        }
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        rawData = XLSX.utils.sheet_to_json(worksheet);
                    } else {
                        importError.textContent = 'Formato de ficheiro não suportado. Use .csv ou .xlsx';
                        return;
                    }
                    
                    if(rawData.length > 0 && !rawData[0]['Data Pedido']){
                        importError.textContent = "A coluna 'Data Pedido' é necessária e não foi encontrada.";
                        return;
                    }

                    showLoading(`A guardar ${rawData.length.toLocaleString('pt-BR')} linhas...`);

                    const db = await dbPromise;
                    const dataTx = db.transaction(DATA_STORE, 'readwrite');
                    const dataStore = dataTx.objectStore(DATA_STORE);
                    rawData.forEach(row => dataStore.add({ ...row, fileName: file.name }));
                    await new Promise(resolve => dataTx.oncomplete = resolve);

                    const fileTx = db.transaction(FILE_STORE, 'readwrite');
                    const fileStore = fileTx.objectStore(FILE_STORE);
                    fileStore.add({ name: file.name, uploadDate: new Date().toISOString() });
                    await new Promise(resolve => fileTx.oncomplete = resolve);
                    
                    allData.push(...rawData.map(r => ({...r, fileName: file.name})));
                    loadedFiles.push({ name: file.name, uploadDate: new Date().toISOString() });

                    renderLoadedFiles();
                    switchView('dashboard');
                    renderDashboard();
                } catch (err) {
                     importError.textContent = 'Ocorreu um erro ao processar o ficheiro.';
                     console.error(err);
                } finally {
                    hideLoading();
                }
            };
            
            if (fileExtension === 'csv') {
                reader.readAsText(file, 'UTF-8');
            } else if (fileExtension === 'xlsx') {
                reader.readAsArrayBuffer(file);
            } else {
                importError.textContent = 'Formato de ficheiro não suportado. Use .csv ou .xlsx';
            }
        };
        
        const removeFile = async (fileNameToRemove) => {
            try {
                showLoading(`A remover o ficheiro ${fileNameToRemove}...`);
                const db = await dbPromise;
                
                const dataTx = db.transaction(DATA_STORE, 'readwrite');
                const dataStore = dataTx.objectStore(DATA_STORE);
                const dataIndex = dataStore.index('fileName');
                const request = dataIndex.openCursor(IDBKeyRange.only(fileNameToRemove));
                
                request.onsuccess = event => {
                    const cursor = event.target.result;
                    if(cursor){
                        cursor.delete();
                        cursor.continue();
                    }
                };
                await new Promise(resolve => dataTx.oncomplete = resolve);

                const fileTx = db.transaction(FILE_STORE, 'readwrite');
                fileTx.objectStore(FILE_STORE).delete(fileNameToRemove);
                await new Promise(resolve => fileTx.oncomplete = resolve);

                allData = allData.filter(row => row.fileName !== fileNameToRemove);
                loadedFiles = loadedFiles.filter(file => file.name !== fileNameToRemove);

                renderLoadedFiles();
                renderDashboard();
            } catch (e) {
                importError.textContent = "Erro ao remover o ficheiro.";
                console.error(e);
            } finally {
                hideLoading();
            }
        };

        const clearAllData = async () => {
            const confirmed = confirm("Tem a certeza que deseja limpar todo o histórico? Esta ação é irreversível.");
            if (!confirmed) return;

            try {
                showLoading('A limpar todo o histórico...');
                const db = await dbPromise;
                
                const dataTx = db.transaction(DATA_STORE, 'readwrite');
                dataTx.objectStore(DATA_STORE).clear();
                await new Promise(resolve => dataTx.oncomplete = resolve);
                
                const fileTx = db.transaction(FILE_STORE, 'readwrite');
                fileTx.objectStore(FILE_STORE).clear();
                await new Promise(resolve => fileTx.oncomplete = resolve);

                allData = [];
                loadedFiles = [];
                
                renderLoadedFiles();
                renderDashboard();
            } catch (e) {
                importError.textContent = "Erro ao limpar o histórico.";
                console.error(e);
            } finally {
                hideLoading();
            }
        };

        // --- EVENT LISTENERS ---
        navDashboard.addEventListener('click', () => switchView('dashboard'));
        navImport.addEventListener('click', () => switchView('import'));
        fileUpload.addEventListener('change', (e) => processFile(e.target.files[0]));
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                processFile(e.dataTransfer.files[0]);
            }
        });
        
        document.body.addEventListener('click', (e) => {
            if (e.target.id === 'go-to-import-btn') {
                switchView('import');
            }
            if(e.target.classList.contains('remove-file-btn')) {
                const filename = e.target.dataset.filename;
                removeFile(filename);
            }
            if(e.target.id === 'clear-history-btn') {
                clearAllData();
            }
            if(e.target.id === 'apply-filter-btn') {
                appliedDateRange.start = document.getElementById('start-date').value;
                appliedDateRange.end = document.getElementById('end-date').value;
                goBackToDashboard();
            }
            if(e.target.id === 'clear-filter-btn') {
                 appliedDateRange = { start: '', end: '' };
                 goBackToDashboard();
            }

            if(e.target.closest('.clickable-bar')) {
                const bar = e.target.closest('.clickable-bar');
                const chart = bar.closest('.bg-white');
                if(chart && chart.id === 'region-performance') {
                    selectedRegion = bar.dataset.label;
                    renderDashboard();
                }
                if(chart && chart.id === 'carrier-performance') {
                    selectedCarrier = bar.dataset.label;
                    renderDashboard();
                }
            }

            if(e.target.closest('.reason-row')) {
                const reasonRow = e.target.closest('.reason-row');
                selectedReason = {
                    reason: reasonRow.dataset.reason,
                    type: reasonRow.dataset.type
                };
                renderDashboard();
            }
            if(e.target.id === 'back-to-dashboard') {
                goBackToDashboard();
            }
        });

        // --- INICIALIZAÇÃO ---
        const initializeApp = async () => {
            showLoading('A carregar dados locais...');
            try {
                const db = await dbPromise;
                const fileTx = db.transaction(FILE_STORE, 'readonly');
                const dataTx = db.transaction(DATA_STORE, 'readonly');

                const filesReq = fileTx.objectStore(FILE_STORE).getAll();
                const dataReq = dataTx.objectStore(DATA_STORE).getAll();
                
                filesReq.onsuccess = () => {
                    loadedFiles = filesReq.result;
                    renderLoadedFiles();
                };
                
                dataReq.onsuccess = () => {
                    allData = dataReq.result;
                    renderDashboard();
                };
            } catch (err) {
                importError.textContent = "Não foi possível carregar os dados guardados.";
                console.error(err);
            } finally {
                hideLoading();
            }
        };

        initializeApp();

    </script>
</body>
</html>

